<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>AR Model - Pinned Final with Audio</title>
    
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.2.0/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <script>
      // *** GESTURE DETECTOR COMPONENT (Unchanged) ***
      AFRAME.registerComponent('gesture-detector', {
        schema: { enabled: { default: true }, sensitivity: { default: 0.5 }, zoomSpeed: { default: 0.01 } },
        init: function () {
          this.isDragging = false;
          this.startX = 0;
          this.startY = 0;
          this.startRotation = { x: 0, y: 0 };
          this.startScale = 5.0; 
          this.el.sceneEl.addEventListener('mousedown', (e) => this.onStart(e));
          this.el.sceneEl.addEventListener('mousemove', (e) => this.onMove(e));
          this.el.sceneEl.addEventListener('mouseup', (e) => this.onEnd(e));
          this.el.sceneEl.addEventListener('touchstart', (e) => this.onTouchStart(e));
          this.el.sceneEl.addEventListener('touchmove', (e) => this.onTouchMove(e));
          this.el.sceneEl.addEventListener('touchend', () => this.onEnd());
          this.el.sceneEl.addEventListener('wheel', (e) => this.onZoom(e));
        },
        onStart: function (event) {
          if (this.data.enabled) {
            this.isDragging = true;
            this.startX = event.screenX;
            this.startY = event.screenY;
            const currentRotation = this.el.getAttribute('rotation');
            this.startRotation = { x: currentRotation.x, y: currentRotation.y };
          }
        },
        onMove: function (event) {
          if (this.isDragging && this.data.enabled) {
            const deltaX = event.screenX - this.startX;
            const deltaY = event.screenY - this.startY;
            const newRotation = {
              x: this.startRotation.x - deltaY * this.data.sensitivity, 
              y: this.startRotation.y + deltaX * this.data.sensitivity, 
            };
            this.el.setAttribute('rotation', newRotation);
          }
        },
        onTouchStart: function (event) {
          if (event.touches.length === 2) {
            this.startDistance = this.getTouchDistance(event.touches);
            this.startScale = this.el.getAttribute('scale').x;
          } else if (event.touches.length === 1) {
            this.onStart(event.touches[0]);
          }
        },
        onTouchMove: function (event) {
          if (event.touches.length === 2) {
            const newDistance = this.getTouchDistance(event.touches);
            const scaleFactor = newDistance / this.startDistance;
            const newScale = Math.min(Math.max(this.startScale * scaleFactor, 0.05), 10.0); 
            this.el.setAttribute('scale', newScale + " " + newScale + " " + newScale);
          } else if (event.touches.length === 1) {
            this.onMove(event.touches[0]);
          }
        },
        onZoom: function (event) {
          const scale = this.el.getAttribute('scale').x;
          let newScale = scale + (event.deltaY * -this.data.zoomSpeed);
          newScale = Math.min(Math.max(newScale, 0.05), 10.0); 
          this.el.setAttribute('scale', newScale + " " + newScale + " " + newScale);
        },
        getTouchDistance: function (touches) {
          const dx = touches[0].clientX - touches[1].clientX;
          const dy = touches[0].clientY - touches[1].clientY;
          return Math.sqrt(dx * dx + dy * dy);
        },
        onEnd: function () {
          this.isDragging = false;
        },
      });
    </script>
    
    <script>
      AFRAME.registerComponent('pin-and-play-audio', {
        init: function() {
          const targetEl = document.querySelector('#target-0');
          const modelEl = this.el;
          const sceneEl = modelEl.sceneEl;

          let isPinned = false;
          let modelReady = false;
          let targetFound = false;
          
          // Function to execute the pinning logic
          const executePinning = () => {
              if (isPinned || !modelReady || !targetFound) return;
              
              isPinned = true;

              // Use a small timeout to ensure one final stable pose is read
              setTimeout(() => {
                  const worldPos = new THREE.Vector3();
                  const worldRot = new THREE.Quaternion();
                  targetEl.object3D.getWorldPosition(worldPos);
                  targetEl.object3D.getWorldQuaternion(worldRot);

                  modelEl.object3D.position.copy(worldPos);
                  modelEl.object3D.quaternion.copy(worldRot);

                  modelEl.setAttribute('visible', true);
                  targetEl.object3D.visible = false;
                  
                  // AUDIO PLAYBACK LOGIC
                  const soundComponent = modelEl.components.sound;
                  if (soundComponent) {
                      soundComponent.playSound();
                      // Fallback for autoplay policy
                      sceneEl.addEventListener('touchstart', function playFallbackAudio() {
                          if (soundComponent.pool.children.length > 0 && soundComponent.pool.children[0].paused) {
                              soundComponent.playSound();
                          }
                          sceneEl.removeEventListener('touchstart', playFallbackAudio);
                      }, { once: true });
                  }
                  console.log("Model pinned and audio initiated!");
              }, 100);
          };

          // Event 1: Model is fully loaded and ready to be manipulated
          modelEl.addEventListener('model-loaded', () => {
              modelReady = true;
              executePinning();
          });
          
          // Event 2: Target is detected by the camera
          targetEl.addEventListener('targetFound', () => {
              targetFound = true;
              executePinning();
          }, { once: true });
        }
      });
    </script>
  </head>
  <body>

    <a-scene 
      mindar-image="imageTargetSrc: /arweb2/targets.mind;" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false"
    >
      <a-assets>
        <a-asset-item id="hardAnimationModel" src="/arweb2/hardanimation.glb"></a-asset-item>
        <audio id="animationAudio" src="/arweb2/hardanimation.mp3" preload="auto"></audio> 
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0" id="target-0"></a-entity>
        
      <a-gltf-model 
        id="pinned-model"
        rotation="0 0 0" 
        position="0 0 0" 
        scale="5.0 5.0 5.0" 
        src="#hardAnimationModel" 
        animation-mixer 
        gesture-detector
        
        sound="src: #animationAudio; autoplay: false; loop: true; volume: 2;"
        
        visible="false"
        
        pin-and-play-audio
      >
      </a-gltf-model>
      
    </a-scene>
    
  </body>
</html>
